#!/usr/bin/env bash
set -euo pipefail

IMAGE="strava-statistics:cve-scan"
RESULTS=$(mktemp)
trap 'rm -f "$RESULTS"' EXIT

echo "Building local image from docker/app/Dockerfile..." >&2
docker build -f docker/app/Dockerfile -t "$IMAGE" . >&2

docker run --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v trivy-cache:/root/.cache/ \
  aquasec/trivy:latest image --format json --quiet "$IMAGE" > "$RESULTS"


count_by_severity() {
  jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$1\")] | length" "$RESULTS"
}

list_by_severity() {
  jq -r ".Results[]?.Vulnerabilities[]? | select(.Severity==\"$1\") | \"| \(.PkgName) | [\(.VulnerabilityID)](https://nvd.nist.gov/vuln/detail/\(.VulnerabilityID)) | \(.InstalledVersion) | \(.FixedVersion // \"not yet\") |\"" "$RESULTS" | sort -u
}

CRITICAL=$(count_by_severity CRITICAL)
HIGH=$(count_by_severity HIGH)
MEDIUM=$(count_by_severity MEDIUM)
LOW=$(count_by_severity LOW)
TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))

echo ""
echo "## Docker Image CVE Report"
echo ""
echo "| Severity | Count |"
echo "|----------|------:|"
echo "| ðŸ”´ Critical | ${CRITICAL} |"
echo "| ðŸŸ  High | ${HIGH} |"
echo "| ðŸŸ¡ Medium | ${MEDIUM} |"
echo "| ðŸ”µ Low | ${LOW} |"
echo "| **Total** | **${TOTAL}** |"
echo ""

if [ "$CRITICAL" -gt 0 ]; then
  echo "<details>"
  echo "<summary>Critical CVEs</summary>"
  echo ""
  echo "| Package | CVE | Installed | Fixed |"
  echo "|---------|-----|-----------|-------|"
  list_by_severity CRITICAL
  echo ""
  echo "</details>"
  echo ""
fi

if [ "$HIGH" -gt 0 ]; then
  echo "<details>"
  echo "<summary>High CVEs</summary>"
  echo ""
  echo "| Package | CVE | Installed | Fixed |"
  echo "|---------|-----|-----------|-------|"
  list_by_severity HIGH
  echo ""
  echo "</details>"
fi
